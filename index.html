<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Carbon Emission Detector</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f6f8;
            text-align: center;
            padding: 20px;
        }

        video,
        img {
            width: 320px;
            border-radius: 8px;
            margin-top: 10px;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            margin-top: 10px;
            cursor: pointer;
        }

        #result {
            background: white;
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
        }
    </style>
</head>

<body>

    <h2>Carbon Emission Detector</h2>

    <video id="video" autoplay></video><br>
    <button onclick="capture()">Capture & Analyze</button>

    <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>

    <div id="result"></div>

    <script>
        const API_KEY = "LoKBChSVoD323FIJxp9E";
        const MODEL_URL = "https://detect.roboflow.com/coco/1280";

        const video = document.getElementById("video");

        // Object → Material mapping
        const materialMap = {
            bottle: "plastic",
            cup: "plastic",
            fork: "plastic",
            knife: "plastic",
            spoon: "plastic",
            toothbrush: "plastic",
            remote: "plastic",
            keyboard: "plastic",
            mouse: "plastic",
            toy: "plastic",
            bag: "plastic",
            bucket: "plastic",

            phone: "metal",
            laptop: "metal",
            computer: "metal",
            tv: "metal",
            monitor: "metal",
            fan: "metal",
            scissors: "metal",
            keys: "metal",
            pan: "metal",
            pot: "metal",

            book: "paper",
            notebook: "paper",
            newspaper: "paper",
            magazine: "paper",
            cardboard: "paper",
            box: "paper",

            glass: "glass",
            bottle_glass: "glass",
            jar: "glass",

            chair: "wood",
            table: "wood",
            desk: "wood",
            bed: "wood",
            door: "wood",

            apple: "organic",
            banana: "organic",
            orange: "organic",
            food: "organic"
        };

        // Material → emission (kg CO₂)
        const emissionValues = {
            plastic: 6.0,
            metal: 8.0,
            paper: 1.3,
            glass: 1.8,
            wood: 0.5,
            electronic: 12.0,
            organic: 0.2,
            soil: 0.1,
            unknown: 0.0
        };

        // Start camera
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => video.srcObject = stream)
            .catch(err => alert("Camera access denied"));

        async function capture() {
            const canvas = document.getElementById("canvas");
            const ctx = canvas.getContext("2d");
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            document.getElementById("result").innerHTML = "Analyzing...";

            // Convert canvas → Blob (CORRECT way)
            const imageBlob = await new Promise(resolve =>
                canvas.toBlob(resolve, "image/jpeg")
            );

            try {
                const formData = new FormData();
                formData.append("file", imageBlob);

                const response = await fetch(
                    `${MODEL_URL}?api_key=${API_KEY}`,
                    {
                        method: "POST",
                        body: formData
                    }
                );

                const data = await response.json();

                if (!data.predictions || data.predictions.length === 0) {
                    document.getElementById("result").innerHTML = "No objects detected.";
                    return;
                }

                let totalEmission = 0;
                let output = "<h3>Detected Objects</h3>";

                data.predictions.forEach(p => {
                    if (p.confidence < 0.4) return;

                    const objectName = p.class_name.toLowerCase();
                    const material = materialMap[objectName] || "unknown";
                    const emission = emissionValues[material] || 0;

                    totalEmission += emission;

                    output += `<p>${objectName} → ${material} → ${emission} kg CO₂</p>`;
                });

                output += `<h3>Total Emission: ${totalEmission.toFixed(2)} kg CO₂</h3>`;
                document.getElementById("result").innerHTML = output;

            } catch (error) {
                console.error(error);
                document.getElementById("result").innerHTML = "AI analysis failed.";
            }
        }
    </script>


</body>

</html>
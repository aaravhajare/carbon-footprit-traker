<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Automatic Carbon Footprint Scanner</title>

    <style>
        body {
            font-family: Arial;
            background: #eef2f3;
            text-align: center;
            padding: 30px;
        }

        video {
            width: 320px;
            border-radius: 10px;
            margin-top: 10px;
            border: 3px solid #27ae60;
        }

        button {
            margin-top: 15px;
            padding: 10px 20px;
            background: #27ae60;
            border: none;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }

        button:disabled {
            background: #aaa;
            cursor: not-allowed;
        }

        .loader {
            margin-top: 15px;
            display: none;
        }

        .result {
            margin-top: 15px;
            font-weight: bold;
        }

        .error {
            color: red;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <h2>Automatic Carbon Footprint Scanner</h2>

    <video id="camera" autoplay playsinline></video>
    <br>
    <button id="scanBtn">Scan & Calculate</button>

    <div class="loader" id="loader">Loading…</div>
    <div class="result" id="result"></div>
    <div class="error" id="error"></div>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>

    <script>
        let model;
        const video = document.getElementById("camera");
        const scanBtn = document.getElementById("scanBtn");
        const loader = document.getElementById("loader");
        const result = document.getElementById("result");
        const errorBox = document.getElementById("error");

        // Map AI detected labels to material
        const materialMap = {
            'paper': 'paper',
            'cardboard': 'paper',
            'book': 'paper',
            'newspaper': 'paper',
            'bottle': 'plastic',
            'can': 'metal',
            'jar': 'glass',
            'cup': 'plastic',
            'keyboard': 'metal',
            'laptop': 'metal'
        };

        // Start camera
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
            } catch {
                errorBox.innerText = "Camera access denied.";
            }
        }

        // Load AI model
        async function loadModel() {
            loader.style.display = "block";
            loader.innerText = "Loading AI model…";
            model = await mobilenet.load();
            loader.style.display = "none";
        }

        // Identify object and map to material
        function getMaterial(label) {
            label = label.toLowerCase();
            for (const key in materialMap) {
                if (label.includes(key)) return materialMap[key];
            }
            return "paper"; // default
        }

        // Scan button
        scanBtn.onclick = async () => {
            if (!model) {
                errorBox.innerText = "Model not loaded yet.";
                return;
            }

            loader.style.display = "block";
            loader.innerText = "Scanning object…";
            result.innerText = "";
            errorBox.innerText = "";
            scanBtn.disabled = true;

            try {
                const predictions = await model.classify(video);
                const label = predictions[0].className;
                const material = getMaterial(label);
                const weightKg = 0.1; // default 100g

                loader.innerText = "Calculating emissions…";

                const controller = new AbortController();
                setTimeout(() => controller.abort(), 8000);

                const res = await fetch("/.netlify/functions/emission", {
                    method: "POST",
                    body: JSON.stringify({ material, weight: weightKg }),
                    signal: controller.signal
                });

                if (!res.ok) throw new Error("API failed");

                const data = await res.json();

                result.innerHTML = `
      Detected: ${label} → Material: ${material}<br>
      Emission: ${data.co2e} kg CO₂e
    `;

            } catch (err) {
                errorBox.innerText = "Failed to calculate emissions.";
            }

            loader.style.display = "none";
            scanBtn.disabled = false;
        }

        // Init
        startCamera();
        loadModel();
    </script>
</body>

</html>